<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>CODM Draw Calculator | Ryzen x Credx</title>

  <style>
    :root {
      --teal-primary: #008080;
      --teal-dark: #006666;
      --teal-light: #e6f2f2;
      --bg-color: #f8fafc;
      --card-bg: #ffffff;
      --text-dark: #1e293b;
      --text-light: #64748b;
      --border-color: #e2e8f0;
      --danger: #ef4444;
      --verified-blue: #1DA1F2;
      --success: #22c55e;
    }

    [data-theme="dark"] {
      --bg-color: #0f172a;
      --card-bg: #1e293b;
      --text-dark: #f1f5f9;
      --text-light: #ffffff;
      --border-color: #334155;
      --teal-light: #134e4a;
    }

    body {
      font-family: 'Inter', system-ui, -apple-system, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-dark);
      margin: 0;
      padding: 20px;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    /* Branding Styles */
    .header-wrapper {
      width: 100%;
      max-width: 500px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 25px;
      padding: 0 10px;
      position: relative;
    }

    .brand-info {
      display: flex;
      flex-direction: column;
      gap: 2px;
    }

    .brand-title {
      font-size: 1.4rem;
      font-weight: 800;
      display: flex;
      align-items: center;
      gap: 8px;
      color: var(--text-dark);
      margin: 0;
    }

    .verified-badge {
      color: var(--verified-blue);
      font-size: 1.2rem;
      animation: pulse-blue 2s infinite;
    }

    @keyframes pulse-blue {
      0% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.8; }
      100% { transform: scale(1); opacity: 1; }
    }

    .brand-subtitle {
      font-size: 0.75rem;
      color: var(--text-light);
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .official-logo {
      width: 75px;
      height: auto;
      object-fit: contain;
      filter: drop-shadow(0 2px 4px rgba(0,0,0,0.1));
    }

    .main-container { width: 100%; max-width: 500px; }

    .card {
      background: var(--card-bg);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      border: 1px solid var(--border-color);
      margin-bottom: 20px;
    }

    h2 {
      color: var(--teal-primary);
      font-weight: 700;
      margin: 0 0 20px 0;
      font-size: 1.1rem;
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .hidden { display: none; }

    label {
      display: block;
      font-size: 0.7rem;
      font-weight: 700;
      color: var(--text-light);
      margin-bottom: 5px;
      text-transform: uppercase;
    }

    input, select {
      width: 100%;
      padding: 12px;
      margin-bottom: 15px;
      border-radius: 8px;
      border: 1px solid var(--border-color);
      background: var(--card-bg);
      color: var(--text-dark);
      box-sizing: border-box;
      font-size: 1rem;
      outline: none;
    }

    .grid-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }

    .check-item {
      display: flex;
      align-items: center;
      padding: 12px;
      background: var(--teal-light);
      border-radius: 8px;
      margin-bottom: 8px;
      cursor: pointer;
      transition: 0.2s;
    }
    .check-item:hover { filter: brightness(0.95); }
    .check-item input { width: auto; margin-right: 12px; transform: scale(1.2); }

    .stats-box, .alt-box {
      padding: 20px;
      border-radius: 12px;
      margin-top: 20px;
      color: white;
      transition: 0.3s ease;
    }

    .stats-box { background: var(--teal-primary); }
    .alt-box { background: #475569; margin-top: 15px; }

    .stat-row { display: flex; justify-content: space-between; margin-bottom: 8px; font-size: 0.9rem; opacity: 0.9; }
    .stat-total { font-size: 1.8rem; font-weight: 800; border-top: 1px solid rgba(255,255,255,0.2); padding-top: 10px; margin-top: 10px; }
    .breakdown { font-size: 0.72rem; color: #fff; margin-top: 8px; line-height: 1.4; border-top: 1px dashed rgba(255,255,255,0.4); padding-top: 8px; }

    .btn {
      background: var(--teal-primary);
      color: white;
      border: none;
      padding: 14px 20px;
      border-radius: 8px;
      font-weight: 700;
      cursor: pointer;
      width: 100%;
      text-transform: uppercase;
      box-shadow: 0 4px 0 var(--teal-dark);
      transition: all 0.1s;
    }
    .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 var(--teal-dark); }

    .btn.btn-success {
      background: var(--success);
      box-shadow: 0 4px 0 #166534;
    }

    .btn-reset { background: var(--danger); margin-top: 10px; box-shadow: 0 4px 0 #991b1b; }

    .footer-note {
      text-align: center;
      font-size: 0.85rem;
      color: var(--text-light);
      line-height: 1.6;
      margin-top: 10px;
      padding: 20px;
      background: var(--teal-light);
      border-radius: 12px;
      border: 1px solid var(--border-color);
    }

    .footer-note a { color: var(--teal-primary); font-weight: 700; text-decoration: none; }
    .warning-text { color: #b91c1c; font-weight: 800; display: block; margin-top: 8px; }

    .mode-switch {
      background: var(--border-color);
      padding: 4px;
      border-radius: 10px;
      display: flex;
      gap: 4px;
      margin-bottom: 20px;
      width: 100%;
      max-width: 500px;
      justify-content: center;
    }
    .mode-btn { padding: 6px 12px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 0.8rem; }
    .mode-btn.active { background: var(--teal-primary); color: white; }

    .template-item {
      display: flex; justify-content: space-between; align-items: center;
      padding: 10px; background: var(--bg-color); border-radius: 8px; margin-bottom: 5px;
    }

    /* ====== Step Cards UI Upgrade ====== */
    .step-card {
      background: var(--card-bg);
      border: 1px solid var(--border-color);
      border-radius: 18px;
      padding: 18px;
      box-shadow: 0 8px 20px rgba(0,0,0,0.06);
      margin-bottom: 14px;
    }

    .step-head {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .step-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .step-badge {
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: grid;
      place-items: center;
      background: var(--teal-primary);
      color: #fff;
      font-weight: 900;
      box-shadow: 0 6px 14px rgba(0,128,128,0.22);
      flex: 0 0 auto;
    }

    .step-title {
      margin: 0;
      font-size: 0.95rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-weight: 900;
      color: var(--text-dark);
    }

    .step-sub {
      margin: 2px 0 0 0;
      font-size: 0.8rem;
      color: var(--text-light);
      font-weight: 600;
    }

    .step-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      justify-content: flex-end;
    }

    .chip {
      font-size: 0.72rem;
      font-weight: 800;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--teal-light);
      border: 1px solid var(--border-color);
      color: var(--text-dark);
    }

    .checklist-wrap {
      max-height: 360px;
      overflow: auto;
      padding-right: 4px;
    }

    .checklist-wrap::-webkit-scrollbar { width: 8px; }
    .checklist-wrap::-webkit-scrollbar-thumb {
      background: var(--border-color);
      border-radius: 999px;
    }

    .check-item { justify-content: flex-start; gap: 10px; user-select: none; }
    .check-item span { font-weight: 800; color: var(--text-dark); }

    .card-row { display: grid; gap: 12px; }
    @media (min-width: 520px) { .card-row { grid-template-columns: 1fr 1fr; } }

    .result-card { padding: 18px; border-radius: 16px; border: 1px solid rgba(255,255,255,0.18); margin-top: 0; }

    .result-title { display: flex; align-items: center; justify-content: space-between; gap: 10px; margin-bottom: 10px; }
    .result-title h3 {
      margin: 0;
      font-size: 0.85rem;
      letter-spacing: 1px;
      text-transform: uppercase;
      font-weight: 900;
      opacity: 0.95;
      color: #fff;
    }

    .result-pill {
      font-size: 0.7rem;
      font-weight: 900;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
      color: #fff;
    }

    .cta-card {
      background: linear-gradient(135deg, var(--teal-primary), var(--teal-dark));
      color: #fff;
      border: 1px solid rgba(255,255,255,0.18);
    }

    .cta-card p { margin: 8px 0 0 0; opacity: 0.9; font-weight: 600; font-size: 0.9rem; }

    .btn-cta { background: #ffffff; color: #0f172a; box-shadow: none; margin-top: 14px; }
    .btn-cta:hover { filter: brightness(0.95); }

    .choice-row { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 12px; }
    .choice {
      flex: 1 1 180px;
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      background: rgba(255,255,255,0.14);
      border: 1px solid rgba(255,255,255,0.18);
      cursor: pointer;
      user-select: none;
    }
    .choice input { width: auto; margin: 0; transform: scale(1.1); }
    .choice b { font-size: 0.85rem; }
    .choice small { display:block; opacity: 0.9; font-weight: 600; margin-top:2px; }
  
    /* âœ… Step 3 Choice Cards Full Black Text */
    .choice {
      background: #ffffff !important;
    }

    .choice b,
    .choice small {
      color: #000 !important;
    }

  
    /* âœ… CTA Button Color Update */
    .btn-cta {
      background: #ffdf01 !important;
      color: #000 !important;
      font-weight: 900;
    }


    /* âœ… Shining Glow Effect for CTA Order Button */
    .btn.btn-cta{
      position: relative;
      overflow: hidden;
      box-shadow: 0 0 12px rgba(255,223,1,0.55),
                  0 0 28px rgba(255,223,1,0.35);
    }
    .btn.btn-cta::before{
      content:"";
      position:absolute;
      top:0;
      left:-70%;
      width:55%;
      height:100%;
      background: rgba(255,255,255,0.45);
      transform: skewX(-25deg);
    }
    .btn.btn-cta:hover::before{
      animation: shineMove 0.9s ease;
    }
    @keyframes shineMove{
      from{ left:-70%; }
      to{ left:130%; }
    }
    .btn.btn-cta:hover{
      transform: translateY(-2px) scale(1.03);
      box-shadow: 0 0 18px rgba(255,223,1,0.85),
                  0 0 45px rgba(255,223,1,0.65);
    }

  </style>
</head>

<body data-theme="light">

  <div class="header-wrapper">
    <div class="brand-info">
      <h1 class="brand-title">Ryzen Discounted Game Credits<span class="verified-badge">âœ”</span></h1>
      <span class="brand-subtitle">Precision Credits Engine</span>
    </div>
    <img src="Logo_Default.png" alt="Ryzen Logo" class="official-logo" />
  </div>

  <div class="mode-switch">
    <button id="btnUser" class="mode-btn active" onclick="showPanel('user')">User</button>
    <button id="btnAdmin" class="mode-btn" onclick="showPanel('admin')">Admin ðŸ”’</button>
    <button class="mode-btn" onclick="toggleTheme()">ðŸŒ“ Mode</button>
  </div>

  <div class="main-container">

    <div id="panelUser" class="card">
      <h2>Draw Calculator</h2>

      <div class="step-card">
        <div class="step-head">
          <div class="step-left">
            <div class="step-badge">1</div>
            <div>
              <p class="step-title">Select Draw</p>
              <p class="step-sub">Choose the lucky draw template you want to calculate.</p>
            </div>
          </div>
          <div class="step-actions">
            <span class="chip">Required</span>
          </div>
        </div>

        <label style="margin-top:6px;">Template Selection</label>
        <select id="userSelector"></select>
      </div>

      <div class="step-card">
        <div class="step-head">
          <div class="step-left">
            <div class="step-badge">2</div>
            <div>
              <p class="step-title">Choose Draws</p>
              <p class="step-sub">Tick the draw numbers you plan to buy.</p>
            </div>
          </div>
          <div class="step-actions">
            <span class="chip">1â€“10</span>
            <span class="chip">Multiple</span>
          </div>
        </div>

        <label class="check-item" style="margin-bottom:10px;">
          <input type="checkbox" id="selectAllDraws" />
          <span>Select All Draws (1â€“10)</span>
        </label>

        <div class="checklist-wrap">
          <div id="userChecklist"></div>
        </div>

        <button class="btn" id="calcBtn" onclick="handleCalculation()">Run Calculator</button>
      </div>

      <div class="step-card">
        <div class="step-head">
          <div class="step-left">
            <div class="step-badge">âœ“</div>
            <div>
              <p class="step-title">Results</p>
              <p class="step-sub">Use Optimized Cost for best value. Alternative uses the Tenths Rule.</p>
            </div>
          </div>
          <div class="step-actions">
            <button class="btn btn-reset" style="width:auto; padding:10px 14px; margin:0;" onclick="resetCalculator()">Reset</button>
          </div>
        </div>

        <div class="card-row">
          <div class="stats-box result-card">
            <div class="result-title">
              <h3>Optimized Cost</h3>
              <span class="result-pill">Best Value</span>
            </div>

            <div class="stat-row"><span>CP:</span> <span id="resCP">0 CP</span></div>
            <div class="stat-row"><span>GS:</span> <span id="resGS">0 GS</span></div>
            <div class="stat-total">â‚±<span id="resPHP">0.00</span></div>
            <div id="gsBreakdown" class="breakdown">Selection results will appear here.</div>
          </div>

          <div id="altCard" class="alt-box result-card hidden">
            <div class="result-title">
              <h3>Alternative</h3>
              <span class="result-pill">Tenths Rule</span>
            </div>

            <div class="stat-row"><span>GS:</span> <span id="altGS">0 GS</span></div>
            <div class="stat-total">â‚±<span id="altPHP">0.00</span></div>
            <div id="altBreakdown" class="breakdown">Breakdown here.</div>
          </div>
        </div>
      </div>

      <div class="step-card cta-card">
        <div class="step-head" style="margin-bottom: 0;">
          <div class="step-left">
            <div class="step-badge" style="background:#fff; color:#0f172a;">3</div>
            <div>
              <p class="step-title" style="color:#fff;">Order Now!</p>
              <p class="step-sub" style="color:rgba(255,255,255,0.9);">Choose the cost option, then send your order note.</p>
            </div>
          </div>
        </div>

        <p>Select which result you want to use for ordering:</p>

        <div class="choice-row">
          <label class="choice">
            <input type="radio" name="costChoice" value="optimized" checked />
            <div>
              <b>Optimized Cost</b>
              <small>Best value combo</small>
            </div>
          </label>

          <label class="choice" id="altChoiceWrap">
            <input type="radio" name="costChoice" value="alternative" />
            <div>
              <b>Alternative</b>
              <small>Tenths Rule</small>
            </div>
          </label>
        </div>

        <button class="btn btn-cta" onclick="orderNow()">ORDER NOW!</button>
      </div>

      <div class="footer-note">
        Top up your CODM CP at discounted prices only at <br><b>Ryzen Discounted Game Credits!</b><br>
        Order now: <a href="https://m.me/ryzendiscountedgamecredits" target="_blank" rel="noopener">m.me/ryzendiscountedgamecredits</a><br>
        <span class="warning-text">Always look for blue check! Beware of posers.</span>
      </div>

      <div class="footer-note">
        <b>Want a draw selection that isnâ€™t on the list?</b><br>
        Email us at: ryzendiscountedgamecredits@gmail.com
      </div>
    </div>

    <div id="panelAdmin" class="card hidden">
      <h2 style="margin:0;">Database Admin</h2>
      <button class="btn btn-reset" style="width: auto; padding: 5px 10px; float: right;" onclick="lockAdmin()">Lock</button>
      <div style="clear:both; padding-top:10px;"></div>

      <label>Template Name</label>
      <input type="text" id="adminDrawName" placeholder="e.g. Mythic Siren" />

      <label>CP Costs (1-10)</label>
      <div class="grid-2" id="adminInputs"></div>

      <button class="btn" onclick="saveToDb()">Save to Local DB</button>

      <div id="adminDeleteList" style="margin-top: 20px;"></div>
    </div>

  </div>

  <script>
    const TIERS = [
      { cp: 2320, gs: 1000, php: 975 },
      { cp: 1080, gs: 500,  php: 490 },
      { cp: 648,  gs: 300,  php: 294 },
      { cp: 416,  gs: 200,  php: 196 },
      { cp: 208,  gs: 100,  php: 98 },
      { cp: 100,  gs: 50,   php: 49 },
      { cp: 40,   gs: 20,   php: 21 },
      { cp: 20,   gs: 10,   php: 11 }
    ];

    const DEFAULT_DB = {
      "Sample Template (Edit Me)": [30, 80, 120, 200, 320, 520, 800, 1300, 2000, 2800]
    };

    function loadDb() {
      try {
        const saved = JSON.parse(localStorage.getItem('drawDatabase') || 'null');
        if (saved && Object.keys(saved).length > 0) return saved;
      } catch (e) {}
      localStorage.setItem('drawDatabase', JSON.stringify(DEFAULT_DB));
      return { ...DEFAULT_DB };
    }

    let db = loadDb();
    let adminUnlocked = false;

    function init() {
      const adminGrid = document.getElementById('adminInputs');
      const userChecks = document.getElementById('userChecklist');
      const selectAll = document.getElementById('selectAllDraws');

      if (!adminGrid || !userChecks || !selectAll) return;

      adminGrid.innerHTML = '';
      userChecks.innerHTML = '';

      for (let i = 1; i <= 10; i++) {
        adminGrid.innerHTML += `<div><input type="number" class="admin-cp" data-idx="${i-1}" placeholder="Draw ${i}"></div>`;
        userChecks.innerHTML += `<label class="check-item"><input type="checkbox" class="user-check" data-idx="${i-1}"><span>Draw ${i}</span></label>`;
      }

      selectAll.addEventListener('change', () => {
        const checked = selectAll.checked;
        document.querySelectorAll('.user-check').forEach(c => c.checked = checked);
      });

      userChecks.addEventListener('change', () => { syncSelectAll(); });

      refreshUI();
      syncSelectAll();
      syncAltChoiceAvailability(false);
    }

    function syncSelectAll() {
      const selectAll = document.getElementById('selectAllDraws');
      const checks = Array.from(document.querySelectorAll('.user-check'));
      if (!selectAll || !checks.length) return;
      selectAll.checked = checks.every(c => c.checked);
    }

    function syncAltChoiceAvailability(showAlt) {
      const altWrap = document.getElementById('altChoiceWrap');
      const altRadio = document.querySelector('input[name="costChoice"][value="alternative"]');
      if (!altWrap || !altRadio) return;

      altRadio.disabled = !showAlt;
      altWrap.style.opacity = showAlt ? "1" : "0.55";
      altWrap.style.cursor = showAlt ? "pointer" : "not-allowed";

      if (!showAlt && altRadio.checked) {
        document.querySelector('input[name="costChoice"][value="optimized"]').checked = true;
      }
    }

    function handleCalculation() {
      const btn = document.getElementById('calcBtn');
      const originalText = btn.innerText;

      const success = calculate();

      if (success !== false) {
        btn.innerText = "Calculation Success!";
        btn.classList.add('btn-success');

        setTimeout(() => {
          btn.innerText = originalText;
          btn.classList.remove('btn-success');
        }, 1200);
      }
    }

    function showPanel(type) {
      if (type === 'admin' && !adminUnlocked) {
        if (prompt("Admin Password:") === "Ryzen2026") adminUnlocked = true;
        else return;
      }
      document.getElementById('panelUser').classList.toggle('hidden', type !== 'user');
      document.getElementById('panelAdmin').classList.toggle('hidden', type !== 'admin');
      document.getElementById('btnUser').classList.toggle('active', type === 'user');
      document.getElementById('btnAdmin').classList.toggle('active', type === 'admin');
    }

    function lockAdmin() { adminUnlocked = false; showPanel('user'); }

    function resetCalculator() {
      document.querySelectorAll('.user-check').forEach(c => c.checked = false);
      const selectAll = document.getElementById('selectAllDraws');
      if (selectAll) selectAll.checked = false;

      const opt = document.querySelector('input[name="costChoice"][value="optimized"]');
      if (opt) opt.checked = true;

      updateDisplay(0,0,0,"", 0,0,"", false);
      syncAltChoiceAvailability(false);
    }

    function saveToDb() {
      const name = document.getElementById('adminDrawName').value.trim();
      if(!name) return;
      db[name] = Array.from(document.querySelectorAll('.admin-cp')).map(i => parseInt(i.value) || 0);
      localStorage.setItem('drawDatabase', JSON.stringify(db));
      refreshUI();
      alert("Template Saved.");
    }

    function refreshUI() {
      const sel = document.getElementById('userSelector');
      const delList = document.getElementById('adminDeleteList');
      sel.innerHTML = '';
      delList.innerHTML = '';

      const names = Object.keys(db);
      if (!names.length) {
        sel.innerHTML = '<option value="">No Templates Found</option>';
        return;
      }

      names.forEach(name => {
        sel.innerHTML += `<option value="${name}">${name}</option>`;
        delList.innerHTML += `<div class="template-item"><span>${name}</span><button class="btn btn-reset" style="width:auto; padding:5px 10px; margin:0;" onclick="deleteTemplate('${name.replace(/'/g, "\'")}')">X</button></div>`;
      });
    }

    function deleteTemplate(name) {
      if(confirm("Delete?")) { delete db[name]; localStorage.setItem('drawDatabase', JSON.stringify(db)); refreshUI(); }
    }

    function getCheapestCombo(targetCP) {
      if (targetCP <= 0) return { gs: 0, php: 0, counts: {} };
      let gsBase = 0, phpBase = 0, initialCounts = {};
      let reducedCP = targetCP;
      while(reducedCP > 2500) {
        gsBase += 1000; phpBase += 975; reducedCP -= 2320;
        initialCounts[1000] = (initialCounts[1000] || 0) + 1;
      }
      let maxSearch = reducedCP + 2320;
      let dp = new Array(maxSearch + 1).fill(Infinity);
      let parent = new Array(maxSearch + 1).fill(null);
      dp[0] = 0;
      for (let i = 0; i < maxSearch; i++) {
        if (dp[i] === Infinity) continue;
        for (let t of TIERS) {
          let next = i + t.cp;
          if (next <= maxSearch) {
            if (dp[i] + t.php < dp[next]) {
              dp[next] = dp[i] + t.php;
              parent[next] = { tier: t, prev: i };
            }
          }
        }
      }
      let bestIdx = reducedCP;
      for (let i = reducedCP; i <= maxSearch; i++) {
        if (dp[i] < dp[bestIdx]) bestIdx = i;
      }
      let curr = bestIdx;
      let finalGS = gsBase, finalPHP = phpBase, finalCounts = {...initialCounts};
      while (curr > 0 && parent[curr]) {
        let t = parent[curr].tier;
        finalGS += t.gs; finalPHP += t.php;
        finalCounts[t.gs] = (finalCounts[t.gs] || 0) + 1;
        curr = parent[curr].prev;
      }
      return { gs: finalGS, php: finalPHP, counts: finalCounts };
    }

    function getAltCombo(targetCP) {
      if (targetCP <= 0) return { gs: 0, php: 0, counts: {} };
      let raw = targetCP / 2320;
      let rounded = Math.ceil(raw * 10) / 10;
      let targetGS = Math.round(rounded * 1000);
      let remain = targetGS, php = 0, counts = {};
      for (let t of TIERS) {
        while (remain >= t.gs) {
          php += t.php; remain -= t.gs;
          counts[t.gs] = (counts[t.gs] || 0) + 1;
        }
      }
      return { gs: targetGS, php: php, counts: counts };
    }

    function calculate() {
      const name = document.getElementById('userSelector').value;
      if(!name || !db[name]) {
        alert("Please select a series.");
        return false;
      }

      let totalCP = 0;
      let selectedIndices = [];
      document.querySelectorAll('.user-check').forEach((c, i) => {
        if(c.checked) {
          totalCP += (db[name][i] || 0);
          selectedIndices.push(i);
        }
      });

      syncSelectAll();

      if (totalCP === 0) {
        updateDisplay(0,0,0,"",0,0,"", false);
        syncAltChoiceAvailability(false);
        return true;
      }
      const onlyLowDraws = selectedIndices.every(idx => idx <= 1);

      const optimized = getCheapestCombo(totalCP);
      const alternative = getAltCombo(totalCP);

      const buildBD = (counts) => Object.entries(counts).sort((a,b)=>b[0]-a[0])
        .map(([gs, c]) => `<b>${c}x</b> ${gs} GS`).join(" + ");

      const showAlt = !onlyLowDraws;

      updateDisplay(totalCP, optimized.gs, optimized.php, buildBD(optimized.counts),
                    alternative.gs, alternative.php, buildBD(alternative.counts), showAlt);

      syncAltChoiceAvailability(showAlt);
      return true;
    }

    function updateDisplay(cp, gs, php, bd, ags, aphp, abd, showAlt) {
      document.getElementById('resCP').innerText = cp.toLocaleString() + ' CP';
      document.getElementById('resGS').innerText = gs.toLocaleString() + ' GS';
      document.getElementById('resPHP').innerText = php.toLocaleString(undefined, {minimumFractionDigits: 2});
      document.getElementById('gsBreakdown').innerHTML = "<b>Breakdown:</b> " + (bd || "â€”");

      document.getElementById('altGS').innerText = ags.toLocaleString() + ' GS';
      document.getElementById('altPHP').innerText = aphp.toLocaleString(undefined, {minimumFractionDigits: 2});
      document.getElementById('altBreakdown').innerHTML = "<b>Breakdown:</b> " + (abd || "â€”");

      document.getElementById('altCard').classList.toggle('hidden', !showAlt);
    }

    function toggleTheme() {
      document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
    }

    function getSelectedDrawsText() {
      const indices = [];
      document.querySelectorAll('.user-check').forEach((c, i) => { if (c.checked) indices.push(i+1); });
      if (!indices.length) return "None";
      return indices.join(", ");
    }

    function orderNow() {
      const template = document.getElementById('userSelector')?.value || "";
      const selectedDraws = getSelectedDrawsText();

      const choice = document.querySelector('input[name="costChoice"]:checked')?.value || "optimized";
      const altVisible = !document.getElementById('altCard')?.classList.contains('hidden');

      const finalChoice = (choice === "alternative" && !altVisible) ? "optimized" : choice;

      const totalCP = document.getElementById('resCP')?.innerText || "0 CP";

      let lineTitle = "";
      let lineCost = "";
      let bdText = "";

      if (finalChoice === "alternative") {
        const gs = document.getElementById('altGS')?.innerText || "0 GS";
        const php = document.getElementById('altPHP')?.innerText || "0.00";
        lineTitle = "Alternative (Tenths Rule)";
        lineCost = `${gs} | â‚±${php}`;
        bdText = document.getElementById('altBreakdown')?.innerText || "";
      } else {
        const gs = document.getElementById('resGS')?.innerText || "0 GS";
        const php = document.getElementById('resPHP')?.innerText || "0.00";
        lineTitle = "Optimized Cost";
        lineCost = `${gs} | â‚±${php}`;
        bdText = document.getElementById('gsBreakdown')?.innerText || "";
      }

      if (!template) {
        alert("Please select a draw template first.");
        return;
      }

      const msg =
`Hi Ryzen! I want to order CODM CP.

âœ… Draw: ${template}
âœ… Selected Draws: ${selectedDraws}
âœ… Total CP: ${totalCP}
âœ… Using: ${lineTitle}
âœ… Cost: ${lineCost}

${bdText ? bdText : ""}

(Please confirm availability & ETA. Thank you!)`;

      const proceed = confirm(
        "You're about to open Messenger.\n\nWe will copy your order note so you can paste it into the chat.\n\nContinue?"
      );
      if (!proceed) return;

      const openMessenger = () => window.open("https://m.me/ryzendiscountedgamecredits", "_blank");

      if (navigator.clipboard?.writeText) {
        navigator.clipboard.writeText(msg).then(() => {
          openMessenger();
          alert("âœ… Order note copied!\nGo ahead and PASTE the order note in Messenger to place your order.");
        }).catch(() => {
          openMessenger();
          prompt("Copy this message and paste it in Messenger:", msg);
          alert("âœ… After copying, paste the order note in Messenger to place your order.");
        });
      } else {
        openMessenger();
        prompt("Copy this message and paste it in Messenger:", msg);
        alert("âœ… After copying, paste the order note in Messenger to place your order.");
      }
    }

    window.addEventListener("DOMContentLoaded", init);
  </script>
</body>
</html>
